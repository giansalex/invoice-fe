{% extends 'base.html.twig' %}

{% block body %}
    <div class="container" ng-app="fe" ng-controller="Main">
        <h1>Nuevo Comprobante</h1>
        <div class="row">
            <div class="col-md-2">
                <label for="tipoDoc">Tipo de Documento</label>
                <select id="tipoDoc"
                        class="form-control"
                        ng-model="doc.tipo"
                        ng-options="item as item.description for item in tipoDocs track by item.code"
                        ng-change="onDocChange()">
                </select>
            </div>
            <div class="col-md-2">
                <label for="serie">Serie</label>
                <input class="form-control" id="serie" ng-model="doc.serie">
            </div>
            <div class="col-md-2">
                <label for="numero">Correlativo</label>
                <input class="form-control" id="numero" ng-model="doc.correlativo">
            </div>
            <div class="col-md-2">
                <label for="emision">Fecha de Emisi√≥n</label>
                <input type="date" class="form-control" id="emision" ng-model="doc.emision">
            </div>
            <div class="col-md-4">
                <label>Cliente</label>
                <angucomplete-alt
                        placeholder="buscar cliente"
                        pause="400"
                        selected-object="doc.client"
                        remote-url="{{ path('client_filter') }}?s="
                        title-field="document,name"
                        minlength="2"
                        input-class="form-control">
                </angucomplete-alt>
            </div>
        </div>
        <div class="row">
            <div class="col-md-2">
                <label form="moneda">Moneda</label>
                <select id="moneda"
                        class="form-control"
                        ng-model="doc.moneda"
                        ng-options="item as item.description for item in monedas track by item.code">
                </select>
            </div>
        </div>
        <br><br>
        <div class="panel panel-default">
            <div class="panel-heading">Detalles</div>
            <div class="panel-body" style="width: 100%">
                <app-detail ng-repeat="detail in details" product="detail" on-delete="removeDetail($index)"></app-detail>
                <br>
                <button class="btn btn-success"
                    ng-click="addDetail()">
                    <i class="fa fa-plus"></i> Agregar
                </button>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    <script src="{{ asset('assets/js/angular.min.js') }}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angucomplete-alt/3.0.0/angucomplete-alt.min.js"></script>
    <script>
        angular.module('fe', ["angucomplete-alt"])
            .factory('FeService', ['$http', function ($http) {
                return {
                    getTiposDoc: getTiposDoc,
                    getSeriesForTipo: getSeriesForTipo,
                    getClients: getClients,
                    getProducts: getProducts,
                    getTaxs: getTaxs,
                    getMonedas: getMonedas
                };

                function getTiposDoc() {
                    return $http.get('{{ path('hierarchy_group', {id: 1}) }}');
                }

                function getSeriesForTipo(tipo) {
                    return $http.post('{{ path('serie_by_doc') }}', tipo);
                }

                function getClients(filter) {
                    return $http.post('{{ path('client_filter') }}', filter);
                }

                function getProducts(filter) {
                    return $http.get('{{ path('productos_filter') }}?s=' + filter);
                }

                function getTaxs() {
                    return $http.get('{{ path('hierarchy_group', {id: 7}) }}');
                }
                
                function getMonedas() {
                    return $http.get('{{ path('hierarchy_group', {id: 2}) }}');
                }
            }])
            .factory('storeService', ['FeService', function ($service) {
                var taxs = null;
                var service = {
                    getTaxs: getTaxs
                };
                var callbacks = [];

                activate();
                return service;

                function activate() {
                    $service.getTaxs()
                        .then(function (r) {
                            taxs = r.data;
                            if (callbacks) {
                                for (var i = 0; i < callbacks.length; i++) {
                                    callbacks[i](taxs);
                                }
                            }
                        });
                }

                function getTaxs(func) {
                    if (taxs) {
                        callbacks = [];
                        func(taxs);
                        return;
                    }
                    callbacks.push(func);
                }

            }])
            .component('appDetail', {
                template: `
                <div class="row">
                    <div class="col-md-2">
                        <label>Producto</label>
                        <angucomplete-alt
                              placeholder="buscar producto"
                              pause="400"
                              selected-object="$ctrl.product.select"
                              remote-url="{{ path('productos_filter') }}?s="
                              title-field="code,name"
                              minlength="2"
                              description-field="price"
                              input-class="form-control form-control-small"
                              match-class="highlight"/>
                    </div>
                    <div class="col-md-1">
                        <label>Cantidad</label>
                        <input class="form-control"
                        type="text" title="cantidad"
                        ng-model="$ctrl.product.cantidad">
                    </div>
                    <div class="col-md-2">
                        <label>Tipo IGV</label>
                         <select class="form-control"
                                ng-model="$ctrl.product.tax"
                                ng-options="item as item.description for item in taxs track by item.code">
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label>Valor Unitario</label>
                        <input
                        ng-model="$ctrl.product.value"
                        class="form-control"
                        type="text"
                        title="valor unitario">
                    </div>
                    <div class="col-md-2">
                        <label>SubTotal</label>
                        <input class="form-control" type="text" title="subtotal">
                    </div>
                    <div class="col-md-2">
                        <label>TOTAL</label>
                        <input class="form-control" type="text" title="total">
                    </div>
                    <div class="col-md-1">
                        <label style="height: 40px;"></label>
                        <button
                        ng-click="$ctrl.onDelete()"
                        class="btn btn-danger"><i class="fa fa-trash"></i></button>
                    </div>
                </div>
                `,
                bindings: {
                    product: '<',
                    onDelete: '&',
                    onUpdate: '&'
                },
                controller: detailController
            })
            .controller('Main', ['$scope', 'FeService', function ($scope, $service) {
                $scope.doc = {};
                $scope.details = [];
                $scope.onDocChange = onDocChange;
                $scope.removeDetail = remove;
                $scope.addDetail = addDetail;
                activate();

                function activate() {
                    $service.getTiposDoc()
                        .then(function (r) {
                            $scope.tipoDocs = r.data;
                        });

                    $service.getMonedas()
                        .then(function (r) {
                            $scope.monedas = r.data;
                        })
                }

                function onDocChange() {
                    var tipo = $scope.doc.tipo;
                    $service.getSeriesForTipo({doc: tipo.code})
                        .then(function (r) {
                            var obj = r.data;
                            $scope.doc.serie = obj.serie;
                            $scope.doc.correlativo = obj.correlativo;
                        }, function () {
                            $scope.doc.serie = '';
                            $scope.doc.correlativo = '';
                        });
                }

                function remove(idx) {
                    $scope.details.splice(idx, 1);
                }

                function addDetail() {
                    $scope.details.push({
                        cantidad: 1,
                        tax: '10',
                        value: 0
                    });
                }
            }]);

        detailController.$inject = ['$scope', 'storeService'];
        function detailController($scope, $store) {
            activate();

            function activate() {
                $store.getTaxs(function (data) {
                    $scope.taxs = data;
                });
            }
        }
    </script>
{% endblock %}
